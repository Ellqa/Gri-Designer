<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gri-Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Urbanist', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            transition: background-color 0.3s ease;
        }

        /* Dark Mode æ ·å¼ */
        body.dark-mode {
            background: #1a1a1a;
        }

        body.dark-mode .container {
            background: #2a2a2a;
        }

        body.dark-mode .title {
            color: #ffffff;
        }

        body.dark-mode .canvas-area {
            background: #333333;
        }

        body.dark-mode .control-panel {
            background: #2a2a2a;
        }

        body.dark-mode .section-title {
            color: #e0e0e0;
        }

        body.dark-mode .label {
            color: #b0b0b0;
        }

        body.dark-mode .input {
            background: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .input:focus {
            border-color: #5a9fd4;
        }

        body.dark-mode .input[readonly] {
            background-color: #333;
        }

        body.dark-mode .unit {
            color: #888;
        }

        body.dark-mode .zoom-btn,
        body.dark-mode .zoom-display {
            background: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .zoom-btn:hover {
            background: #444;
            border-color: #666;
        }

        body.dark-mode .canvas {
            background: #ffffff;
        }

        body.dark-mode .control-panel::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        body.dark-mode .control-panel::-webkit-scrollbar-thumb {
            background: #555;
        }

        body.dark-mode .control-panel::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .container {
            width: 100%;
            min-height: calc(100vh + 360px);
            position: relative;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-mode .theme-toggle {
            background: #3a3a3a;
            border-color: #555;
        }

        .theme-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background-color 0.2s;
            position: relative;
        }

        .theme-option:hover {
            background: #f0f0f0;
        }

        body.dark-mode .theme-option:hover {
            background: #444;
        }

        .theme-option.active {
            background: #007bff;
        }

        body.dark-mode .theme-option.active {
            background: #5a9fd4;
        }

        .theme-option.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
        }

        /* é¡µé¢è¾¹è· */
        .page-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* æ ‡é¢˜åŒºåŸŸ */
        .header {
            height: 340px;
            display: flex;
            align-items: center;
            margin: 0 20px;
            position: relative;
        }


        .title {
            font-family: 'Urbanist', sans-serif;
            font-weight: 100;
            font-size: 220px;
            line-height: 150px;
            color: #000;
            transition: color 0.3s ease;
        }

        .title-line1 {
            display: block;
        }

        .title-line2 {
            display: block;
            text-indent: 40px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: flex;
            gap: 20px;
            height: 100vh;
            margin: 0 0 -20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            position: sticky;
            top: 0;
        }

        body.dark-mode .main-content {
            background: #2a2a2a;
        }

        /* å·¦ä¾§ç”»å¸ƒåŒºåŸŸ */
        .canvas-area {
            flex: 1;
            background: #e5e5e5;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease;
            min-height: 0;
        }

        /* ç¼©æ”¾æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: 300;
            color: #333;
            transition: all 0.2s, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            user-select: none;
        }

        .zoom-btn:hover {
            background: #f8f8f8;
            border-color: #999;
        }

        .zoom-btn:active {
            background: #e8e8e8;
            transform: scale(0.95);
        }

        .zoom-display {
            width: 60px;
            height: 36px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-weight: 500;
            text-align: center;
            padding: 0 4px;
            font-family: 'Urbanist', sans-serif;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .zoom-display:focus {
            outline: none;
            border-color: #007bff;
        }

        .canvas-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center;
        }

        .canvas-container.animating {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .canvas {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }

        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body.dark-mode .canvas-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.2) 1px, transparent 1px);
        }

        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            width: 500px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .label {
            font-size: 14px;
            color: #666;
            min-width: 60px;
            transition: color 0.3s ease;
        }

        .input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Urbanist', sans-serif;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .input:focus {
            outline: none;
            border-color: #007bff;
        }

        .input[readonly] {
            background-color: #f5f5f5;
            cursor: default;
        }

        .unit {
            font-size: 12px;
            color: #999;
            min-width: 30px;
        }

        /* æ»‘æ†æ ·å¼ */
        .slider {
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .slider:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: #999;
        }

        .slider:disabled::-moz-range-thumb {
            cursor: not-allowed;
            background: #999;
        }

        /* Margin æ§åˆ¶æ ·å¼ */
        .margin-grid {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .margin-column {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .margin-controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .margin-control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .margin-control .label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        body.dark-mode .margin-control .label {
            color: #b0b0b0;
        }

        .stepper {
            display: flex;
            align-items: stretch;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            transition: border-color 0.3s ease;
            max-width: 160px;
        }

        .stepper-btn {
            flex: 0 0 32px;
            border: none;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 300;
            color: #333;
            transition: all 0.2s;
            user-select: none;
        }

        .stepper-btn:first-child {
            border-right: 1px solid #ddd;
        }

        .stepper-btn:last-child {
            border-left: 1px solid #ddd;
        }

        .stepper-btn:hover {
            background: #f8f8f8;
        }

        .stepper-btn:active {
            background: #e8e8e8;
            transform: scale(0.95);
        }

        .stepper-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        body.dark-mode .stepper {
            border-color: #555;
        }

        body.dark-mode .stepper-btn {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        body.dark-mode .stepper-btn:hover {
            background: #444;
        }

        .margin-input {
            flex: 1;
            text-align: center;
            padding: 6px;
            border: none;
            background: transparent;
            min-width: 35px;
            font-size: 13px;
        }

        .stepper .unit {
            padding: 0 6px;
            display: flex;
            align-items: center;
            color: #999;
            font-size: 11px;
            transition: color 0.3s ease;
        }

        body.dark-mode .stepper .unit {
            color: #888;
        }

        /* Margin é”å®šæŒ‰é’® */
        .margin-lock {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            padding-right: 30px;
        }

        .lock-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            padding: 7px;
        }

        .lock-btn svg {
            width: 100%;
            height: 100%;
            color: #666;
            transition: color 0.2s, transform 0.2s;
            transform: rotate(-45deg);
        }

        .lock-btn:hover {
            background: #f8f8f8;
            border-color: #999;
        }

        .lock-btn:hover svg {
            color: #333;
        }

        .lock-btn.locked {
            background: #007bff;
            border-color: #007bff;
        }

        .lock-btn.locked svg {
            color: white;
        }

        body.dark-mode .lock-btn {
            background: #3a3a3a;
            border-color: #555;
        }

        body.dark-mode .lock-btn svg {
            color: #b0b0b0;
        }

        body.dark-mode .lock-btn:hover {
            background: #444;
            border-color: #666;
        }

        body.dark-mode .lock-btn:hover svg {
            color: #e0e0e0;
        }

        body.dark-mode .lock-btn.locked {
            background: #5a9fd4;
            border-color: #5a9fd4;
        }

        body.dark-mode .lock-btn.locked svg {
            color: white;
        }

        /* Canvas margin æ˜¾ç¤ºä¸ºçº¿ */
        .canvas-margin {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* Canvas columns/rows å®¹å™¨ */
        .canvas-columns,
        .canvas-rows {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* Column çº¿ï¼ˆçºµå‘ï¼Œå‚ç›´çº¿ï¼‰*/
        .column-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #00ffff;
            opacity: 0.6;
            pointer-events: none;
        }

        /* Row çº¿ï¼ˆæ¨ªå‘ï¼Œæ°´å¹³çº¿ï¼‰*/
        .row-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ffff;
            opacity: 0.6;
            pointer-events: none;
        }

        .canvas-margin.left {
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0080;
            border: none;
        }

        .canvas-margin.right {
            right: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0080;
            border: none;
        }

        .canvas-margin.top {
            left: 0;
            right: 0;
            top: 0;
            height: 2px;
            background: #ff0080;
            border: none;
        }

        .canvas-margin.bottom {
            left: 0;
            right: 0;
            bottom: 0;
            height: 2px;
            background: #ff0080;
            border: none;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .control-panel::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»é¢˜åˆ‡æ¢ -->
        <div class="theme-toggle">
            <button class="theme-option" data-theme="auto" title="è·Ÿéšç³»ç»Ÿ">ğŸŒ“</button>
            <button class="theme-option" data-theme="light" title="äº®è‰²æ¨¡å¼">â˜€ï¸</button>
            <button class="theme-option" data-theme="dark" title="æš—è‰²æ¨¡å¼">ğŸŒ™</button>
        </div>

        <div class="page-content">
            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <div class="header">
                <h1 class="title">
                    <span class="title-line1">Gri-</span>
                    <span class="title-line2">Designer</span>
                </h1>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- å·¦ä¾§ç”»å¸ƒåŒºåŸŸ -->
                <div class="canvas-area" id="canvasArea">
                    <div class="canvas-container" id="canvasContainer">
                        <div class="canvas" id="canvas">
                            <div class="canvas-margin left" id="marginLeftVis"></div>
                            <div class="canvas-margin right" id="marginRightVis"></div>
                            <div class="canvas-margin top" id="marginTopVis"></div>
                            <div class="canvas-margin bottom" id="marginBottomVis"></div>
                            <div class="canvas-grid"></div>
                            <div class="canvas-columns" id="canvasColumns"></div>
                            <div class="canvas-rows" id="canvasRows"></div>
                        </div>
                    </div>
                    
                    <!-- ç¼©æ”¾æ§åˆ¶ -->
                    <div class="zoom-controls">
                        <div class="zoom-btn" id="focusCanvas" title="é€‚é…ç”»å¸ƒ">âŠ™</div>
                        <div class="zoom-btn" id="zoomOut">âˆ’</div>
                        <input type="text" class="zoom-display" id="zoomDisplay" value="100%">
                        <div class="zoom-btn" id="zoomIn">+</div>
                    </div>
                </div>

                <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <!-- Page Size Section -->
                    <div class="section">
                        <div class="section-title">Page Size</div>
                        <div class="input-row">
                            <span class="label">Width</span>
                            <input type="number" class="input" id="pageWidth" value="792" min="50" max="2000" step="1">
                            <span class="unit">pt</span>
                        </div>
                        <div class="input-row">
                            <span class="label">Height</span>
                            <input type="number" class="input" id="pageHeight" value="1224" min="50" max="2000" step="1">
                            <span class="unit">pt</span>
                        </div>
                    </div>

                    <!-- Module Section - Hidden (logic integrated into Grid Size) -->
                    <div class="section" style="display: none;">
                        <div class="section-title">Module</div>
                        <div class="input-row">
                            <input type="range" class="slider" id="moduleSlider" min="0" max="0" value="0" step="1">
                            <input type="text" class="input" id="moduleDisplay" value="-" readonly style="width: 60px; text-align: center;">
                                <span class="unit">pt</span>
                            </div>
                            </div>

                    <!-- Grid Size Section -->
                    <div class="section">
                        <div class="section-title">Grid Size</div>
                        <div class="input-row">
                            <input type="range" class="slider" id="gridSizeSlider" min="0" max="0" value="0" step="1">
                            <input type="text" class="input" id="gridSizeDisplay" value="-" readonly style="width: 60px; text-align: center;">
                                <span class="unit">pt</span>
                        </div>
                    </div>

                    <!-- Margin Section -->
                    <div class="section">
                        <div class="section-title">Margin</div>
                        <div class="margin-grid">
                            <!-- Left/Right Column -->
                            <div class="margin-column">
                                <div class="margin-controls-wrapper">
                                    <div class="margin-control">
                                        <span class="label">Left</span>
                                        <div class="stepper">
                                            <button class="stepper-btn" data-margin="left" data-dir="-1">âˆ’</button>
                                            <input type="text" class="input margin-input" id="marginLeft" value="0" readonly>
                            <span class="unit">pt</span>
                                            <button class="stepper-btn" data-margin="left" data-dir="1">+</button>
                        </div>
                        </div>
                                    <div class="margin-control">
                                        <span class="label">Right</span>
                                        <div class="stepper">
                                            <button class="stepper-btn" data-margin="right" data-dir="-1">âˆ’</button>
                                            <input type="text" class="input margin-input" id="marginRight" value="0" readonly>
                            <span class="unit">pt</span>
                                            <button class="stepper-btn" data-margin="right" data-dir="1">+</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="margin-lock">
                                    <button class="lock-btn" id="lockHorizontal" title="é”å®šå·¦å³">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="icon-unlocked"><rect width="256" height="256" fill="none"/><path d="M192,120l12.28-11.72a40,40,0,0,0-56.56-56.56L136,64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path d="M64,136,51.72,147.72a40,40,0,0,0,56.56,56.56L120,192" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="192" y1="160" x2="216" y2="160" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="40" y1="96" x2="64" y2="96" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="160" y1="192" x2="160" y2="216" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="96" y1="40" x2="96" y2="64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="icon-locked" style="display: none;"><rect width="256" height="256" fill="none"/><path d="M141.38,64.68l11-11a46.62,46.62,0,0,1,65.94,0h0a46.62,46.62,0,0,1,0,65.94L193.94,144,183.6,154.34a46.63,46.63,0,0,1-66-.05h0A46.48,46.48,0,0,1,104,120.06" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path d="M114.62,191.32l-11,11a46.63,46.63,0,0,1-66-.05h0a46.63,46.63,0,0,1,.06-65.89L72.4,101.66a46.62,46.62,0,0,1,65.94,0h0A46.45,46.45,0,0,1,152,135.94" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/></svg>
                                    </button>
                        </div>
                    </div>

                            <!-- Top/Bottom Column -->
                            <div class="margin-column">
                                <div class="margin-controls-wrapper">
                                    <div class="margin-control">
                                        <span class="label">Top</span>
                                        <div class="stepper">
                                            <button class="stepper-btn" data-margin="top" data-dir="-1">âˆ’</button>
                                            <input type="text" class="input margin-input" id="marginTop" value="0" readonly>
                            <span class="unit">pt</span>
                                            <button class="stepper-btn" data-margin="top" data-dir="1">+</button>
                        </div>
                        </div>
                                    <div class="margin-control">
                                        <span class="label">Bottom</span>
                                        <div class="stepper">
                                            <button class="stepper-btn" data-margin="bottom" data-dir="-1">âˆ’</button>
                                            <input type="text" class="input margin-input" id="marginBottom" value="0" readonly>
                            <span class="unit">pt</span>
                                            <button class="stepper-btn" data-margin="bottom" data-dir="1">+</button>
                        </div>
                    </div>
                        </div>
                                <div class="margin-lock">
                                    <button class="lock-btn" id="lockVertical" title="é”å®šä¸Šä¸‹">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="icon-unlocked"><rect width="256" height="256" fill="none"/><path d="M192,120l12.28-11.72a40,40,0,0,0-56.56-56.56L136,64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path d="M64,136,51.72,147.72a40,40,0,0,0,56.56,56.56L120,192" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="192" y1="160" x2="216" y2="160" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="40" y1="96" x2="64" y2="96" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="160" y1="192" x2="160" y2="216" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><line x1="96" y1="40" x2="96" y2="64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="icon-locked" style="display: none;"><rect width="256" height="256" fill="none"/><path d="M141.38,64.68l11-11a46.62,46.62,0,0,1,65.94,0h0a46.62,46.62,0,0,1,0,65.94L193.94,144,183.6,154.34a46.63,46.63,0,0,1-66-.05h0A46.48,46.48,0,0,1,104,120.06" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path d="M114.62,191.32l-11,11a46.63,46.63,0,0,1-66-.05h0a46.63,46.63,0,0,1,.06-65.89L72.4,101.66a46.62,46.62,0,0,1,65.94,0h0A46.45,46.45,0,0,1,152,135.94" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/></svg>
                                    </button>
                        </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column/Row Section -->
                    <div class="section">
                        <div class="section-title">Column/Row</div>
                        
                        <!-- Column Controls -->
                        <div class="input-group">
                            <div class="input-row">
                                <span class="label" style="min-width: 120px;">Column Spacing</span>
                                <div class="stepper" style="max-width: 160px;">
                                    <button class="stepper-btn" id="columnSpacingDown">âˆ’</button>
                                    <input type="text" class="input margin-input" id="columnSpacing" value="-" readonly>
                                    <span class="unit">pt</span>
                                    <button class="stepper-btn" id="columnSpacingUp">+</button>
                                </div>
                            </div>
                            <div class="input-row">
                                <span class="label" style="min-width: 120px;">Column Number</span>
                                <input type="range" class="slider" id="columnSlider" min="0" max="0" value="0" step="1" disabled>
                                <input type="text" class="input" id="columnDisplay" value="-" readonly style="width: 60px; text-align: center;">
                            </div>
                        </div>
                        
                        <!-- Row Controls -->
                        <div class="input-group">
                            <div class="input-row">
                                <span class="label" style="min-width: 120px;">Row Spacing</span>
                                <div class="stepper" style="max-width: 160px;">
                                    <button class="stepper-btn" id="rowSpacingDown">âˆ’</button>
                                    <input type="text" class="input margin-input" id="rowSpacing" value="-" readonly>
                                    <span class="unit">pt</span>
                                    <button class="stepper-btn" id="rowSpacingUp">+</button>
                                </div>
                            </div>
                            <div class="input-row">
                                <span class="label" style="min-width: 120px;">Row Number</span>
                                <input type="range" class="slider" id="rowSlider" min="0" max="0" value="0" step="1" disabled>
                                <input type="text" class="input" id="rowDisplay" value="-" readonly style="width: 60px; text-align: center;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class GriDesigner {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.canvasContainer = document.getElementById('canvasContainer');
                this.scale = 1;
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;
                this.offsetX = 0;
                this.offsetY = 0;
                this.moduleOptions = [];
                this.currentModule = null;
                this.gridSizeOptions = [];
                this.currentGridSize = null;
                this.margins = { left: 0, top: 0, right: 0, bottom: 0 };
                this.marginLocks = { horizontal: true, vertical: true };
                this.currentTheme = 'auto'; // 'auto', 'light', 'dark'
                
                // Column/Row ç›¸å…³
                this.columnSpacing = null;  // é»˜è®¤ä¸º grid size
                this.rowSpacing = null;     // é»˜è®¤ä¸º grid size
                this.columnOptions = [];
                this.rowOptions = [];
                this.currentColumnNumber = null;
                this.currentRowNumber = null;
                
                this.init();
            }

            init() {
                this.setupTheme();
                this.setupEventListeners();
                this.setupCanvas();
            }

            setupTheme() {
                // ä» localStorage è¯»å–ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
                const savedTheme = localStorage.getItem('theme') || 'auto';
                this.currentTheme = savedTheme;
                
                // åº”ç”¨ä¸»é¢˜
                this.applyTheme(savedTheme);
                
                // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    if (this.currentTheme === 'auto') {
                        this.applyTheme('auto');
                    }
                });
                
                // è®¾ç½®ä¸»é¢˜æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.theme-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const theme = e.currentTarget.getAttribute('data-theme');
                        this.setTheme(theme);
                    });
                });
            }

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem('theme', theme);
                this.applyTheme(theme);
            }

            applyTheme(theme) {
                const body = document.body;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.theme-option').forEach(btn => {
                    if (btn.getAttribute('data-theme') === theme) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // åº”ç”¨ä¸»é¢˜
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                } else if (theme === 'light') {
                    body.classList.remove('dark-mode');
                } else if (theme === 'auto') {
                    // è·Ÿéšç³»ç»Ÿ
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        body.classList.add('dark-mode');
                    } else {
                        body.classList.remove('dark-mode');
                    }
                }
            }

            setupEventListeners() {
                // ç”»å¸ƒç¼©æ”¾ - é€Ÿåº¦ä¸æ»šè½®é‡æˆæ­£æ¯”
                this.canvasContainer.parentElement.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    // è®¡ç®—ç¼©æ”¾å¢é‡ï¼Œä¸æ»šåŠ¨é‡æˆæ­£æ¯”
                    const zoomSpeed = 0.001; // è°ƒæ•´è¿™ä¸ªå€¼æ¥æ§åˆ¶æ•´ä½“ç¼©æ”¾é€Ÿåº¦
                    const deltaScale = -e.deltaY * zoomSpeed; // è´Ÿå·æ˜¯å› ä¸ºdeltaYå‘ä¸‹ä¸ºæ­£ï¼Œæˆ‘ä»¬è¦æ”¾å¤§
                    this.scale += this.scale * deltaScale; // æŒ‰å½“å‰ç¼©æ”¾çš„ç™¾åˆ†æ¯”å¢å‡
                    this.scale = Math.max(0.05, Math.min(5, this.scale));
                    this.updateCanvasTransform();
                    this.updateZoomDisplay();
                });

                // ç”»å¸ƒæ‹–æ‹½
                this.canvasContainer.parentElement.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    this.canvasContainer.parentElement.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        const deltaX = e.clientX - this.lastX;
                        const deltaY = e.clientY - this.lastY;
                        this.offsetX += deltaX;
                        this.offsetY += deltaY;
                        this.lastX = e.clientX;
                        this.lastY = e.clientY;
                        this.updateCanvasTransform();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.isDragging) {
                    this.isDragging = false;
                        this.canvasContainer.parentElement.style.cursor = 'default';
                    }
                });

                // Focus æŒ‰é’® - é€‚é…ç”»å¸ƒ
                document.getElementById('focusCanvas').addEventListener('click', () => {
                    const widthPt = parseFloat(document.getElementById('pageWidth').value);
                    const heightPt = parseFloat(document.getElementById('pageHeight').value);
                    if (widthPt && heightPt) {
                        this.fitCanvasToView(widthPt, heightPt, true); // å¯ç”¨åŠ¨ç”»
                    }
                });

                // ç¼©æ”¾æŒ‰é’® - round to æœ€è¿‘çš„ Â±25%
                document.getElementById('zoomIn').addEventListener('click', () => {
                    this.zoomToNearest25(1); // +1 è¡¨ç¤ºå‘ä¸Š
                });

                document.getElementById('zoomOut').addEventListener('click', () => {
                    this.zoomToNearest25(-1); // -1 è¡¨ç¤ºå‘ä¸‹
                });

                // ç¼©æ”¾è¾“å…¥æ¡†
                const zoomInput = document.getElementById('zoomDisplay');
                
                // é™åˆ¶åªèƒ½è¾“å…¥æ•°å­—
                zoomInput.addEventListener('keydown', (e) => {
                    this.restrictToNumbers(e, true); // true è¡¨ç¤ºå…è®¸å°æ•°ç‚¹
                });
                
                // é™åˆ¶ç²˜è´´å†…å®¹
                zoomInput.addEventListener('paste', (e) => {
                    this.handleNumberPaste(e);
                });
                
                zoomInput.addEventListener('change', (e) => {
                    this.handleZoomInput(e.target.value);
                });
                
                zoomInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleZoomInput(e.target.value);
                        e.target.blur();
                    }
                });

                // æ§åˆ¶é¢æ¿äº¤äº’
                this.setupControlPanel();
            }

            zoomToNearest25(direction) {
                const currentPercent = this.scale * 100;
                let targetPercent;
                
                if (direction > 0) {
                    // å‘ä¸Š roundï¼šæ‰¾åˆ°ä¸‹ä¸€ä¸ª 25 çš„å€æ•°
                    targetPercent = Math.ceil(currentPercent / 25) * 25;
                    // å¦‚æœå½“å‰å·²ç»æ˜¯ 25 çš„å€æ•°ï¼Œå°±åŠ  25
                    if (targetPercent === currentPercent) {
                        targetPercent += 25;
                    }
                    // é™åˆ¶èŒƒå›´
                    targetPercent = Math.max(5, Math.min(500, targetPercent));
                    this.scale = targetPercent / 100;
                    this.updateCanvasTransform(true); // å¯ç”¨åŠ¨ç”»
                    this.updateZoomDisplay();
                } else {
                    // å‘ä¸‹ roundï¼šæ‰¾åˆ°ä¸Šä¸€ä¸ª 25 çš„å€æ•°
                    targetPercent = Math.floor(currentPercent / 25) * 25;
                    // å¦‚æœå½“å‰å·²ç»æ˜¯ 25 çš„å€æ•°ï¼Œå°±å‡ 25
                    if (targetPercent === currentPercent) {
                        targetPercent -= 25;
                    }
                    
                    // å¦‚æœè¦ç¼©å°åˆ° 25% ä»¥ä¸‹ï¼Œæ£€æŸ¥ç”»å¸ƒæ˜¯å¦èƒ½å®Œå…¨å±•ç¤º
                    if (targetPercent < 25) {
                        // è·å–å½“å‰ç”»å¸ƒå°ºå¯¸
                        const widthPt = parseFloat(document.getElementById('pageWidth').value);
                        const heightPt = parseFloat(document.getElementById('pageHeight').value);
                        
                        if (widthPt && heightPt) {
                            // è®¡ç®—èƒ½å®Œå…¨å±•ç¤ºç”»å¸ƒçš„ç¼©æ”¾æ¯”ä¾‹
                            const canvasWidthPx = this.ptToPx(widthPt);
                            const canvasHeightPx = this.ptToPx(heightPt);
                            const canvasArea = this.canvasContainer.parentElement;
                            const areaWidth = canvasArea.clientWidth;
                            const areaHeight = canvasArea.clientHeight;
                            const margin = 20;
                            const availableWidth = areaWidth - margin * 2;
                            const availableHeight = areaHeight - margin * 2;
                            const scaleX = availableWidth / canvasWidthPx;
                            const scaleY = availableHeight / canvasHeightPx;
                            const fitScale = Math.min(scaleX, scaleY, 3);
                            const fitPercent = fitScale * 100;
                            
                            // å¦‚æœåœ¨ 25% æ—¶ç”»å¸ƒè¿˜ä¸èƒ½å®Œå…¨å±•ç¤ºï¼Œå°±ç›´æ¥è·³åˆ°é€‚é…æ¯”ä¾‹
                            if (fitPercent < 25) {
                                this.scale = fitScale;
                                this.offsetX = 0;
                                this.offsetY = 0;
                                this.updateCanvasTransform(true); // å¯ç”¨åŠ¨ç”»
                                this.updateZoomDisplay();
                                return;
                            }
                        }
                    }
                    
                    // å¦åˆ™æ­£å¸¸ç¼©å°åˆ°ç›®æ ‡ç™¾åˆ†æ¯”
                    targetPercent = Math.max(5, Math.min(500, targetPercent));
                    this.scale = targetPercent / 100;
                    this.updateCanvasTransform(true); // å¯ç”¨åŠ¨ç”»
                    this.updateZoomDisplay();
                }
            }

            handleZoomInput(value) {
                // ç§»é™¤ % ç¬¦å·å¹¶è§£ææ•°å­—
                const numValue = parseFloat(value.replace('%', ''));
                if (!isNaN(numValue) && numValue > 0) {
                    // é™åˆ¶èŒƒå›´ 5% - 500%
                    this.scale = Math.max(0.05, Math.min(5, numValue / 100));
                    this.updateCanvasTransform(true); // å¯ç”¨åŠ¨ç”»
                }
                this.updateZoomDisplay();
            }

            updateZoomDisplay() {
                const zoomPercent = Math.round(this.scale * 100);
                document.getElementById('zoomDisplay').value = zoomPercent + '%';
            }

            setupCanvas() {
                // è®¾ç½®åˆå§‹ç”»å¸ƒå¤§å°
                this.updateCanvasSize();
                // åˆå§‹åŒ–ç¼©æ”¾æ˜¾ç¤º
                this.updateZoomDisplay();
                // åˆå§‹åŒ– module é€‰é¡¹
                this.updateModuleOptions();
                // åˆå§‹åŒ– margin æ˜¾ç¤º
                this.updateCanvasMargins();
                // åˆå§‹åŒ– margin æŒ‰é’®çŠ¶æ€
                this.updateMarginButtonsState();
            }

            // å°†ptè½¬æ¢ä¸ºpxç”¨äºè®¡ç®—æ˜¾ç¤ºå°ºå¯¸ (1pt = 4/3 px)
            ptToPx(pt) {
                return pt * 4 / 3;
            }

            // è´¨å› æ•°åˆ†è§£ - è¿”å› [(prime, power), ...] æ ¼å¼
            getPrimeFactorization(n) {
                if (n < 2) return [];
                
                const factors = [];
                
                // åˆ†è§£å‡ºæ‰€æœ‰çš„2
                let count = 0;
                while (n % 2 === 0) {
                    count++;
                    n = Math.floor(n / 2);
                }
                if (count > 0) {
                    factors.push([2, count]);
                }
                
                // åˆ†è§£å¥‡æ•°è´¨å› æ•°
                let p = 3;
                while (p * p <= n) {
                    count = 0;
                    while (n % p === 0) {
                        count++;
                        n = Math.floor(n / p);
                    }
                    if (count > 0) {
                        factors.push([p, count]);
                    }
                    p += 2;
                }
                
                // å¦‚æœå‰©ä½™çš„n > 1ï¼Œè¯´æ˜å®ƒæœ¬èº«æ˜¯è´¨æ•°
                if (n > 1) {
                    factors.push([n, 1]);
                }
                
                return factors;
            }

            // è·å–è´¨å› æ•°åˆ—è¡¨ï¼ˆä¸å¸¦ powerï¼‰
            getPrimeFactors(n) {
                const factorization = this.getPrimeFactorization(n);
                const factors = [];
                for (const [prime, power] of factorization) {
                    for (let i = 0; i < power; i++) {
                        factors.push(prime);
                    }
                }
                return factors;
            }

            // æ‰¾åˆ°ä¸¤ä¸ªæ•°çš„å…±åŒè´¨å› æ•°
            findCommonPrimeFactors(x, y) {
                const xFactors = this.getPrimeFactors(x);
                const yFactors = this.getPrimeFactors(y);
                
                // æ‰¾åˆ°å…±åŒçš„è´¨å› æ•°ï¼ˆå»é‡ï¼‰
                const commonFactors = [];
                const ySet = new Set(yFactors);
                
                for (const factor of xFactors) {
                    if (ySet.has(factor) && !commonFactors.includes(factor)) {
                        commonFactors.push(factor);
                    }
                }
                
                return commonFactors.sort((a, b) => a - b);
            }

            // æ›´æ–° module é€‰é¡¹
            updateModuleOptions() {
                const width = parseInt(document.getElementById('pageWidth').value);
                const height = parseInt(document.getElementById('pageHeight').value);
                
                if (!width || !height || width < 2 || height < 2) {
                    this.moduleOptions = [];
                    this.updateModuleUI();
                    return;
                }
                
                // æ‰¾åˆ°å…±åŒçš„è´¨å› æ•°
                this.moduleOptions = this.findCommonPrimeFactors(width, height);
                
                console.log(`Width: ${width}, Height: ${height}`);
                console.log(`Common prime factors: ${this.moduleOptions.join(', ')}`);
                
                this.updateModuleUI();
            }

            // æ›´æ–° module UI
            updateModuleUI() {
                const slider = document.getElementById('moduleSlider');
                const display = document.getElementById('moduleDisplay');
                
                // Module UI å·²éšè—ï¼Œä½†ä¿ç•™é€»è¾‘ä»¥ä¾¿å…¼å®¹
                if (this.moduleOptions.length === 0) {
                    slider.disabled = true;
                    slider.min = 0;
                    slider.max = 0;
                    slider.value = 0;
                    display.value = '-';
                    this.currentModule = null;
                } else {
                    slider.disabled = false;
                    slider.min = 0;
                    slider.max = this.moduleOptions.length - 1;
                    slider.value = 0;
                    this.currentModule = this.moduleOptions[0];
                    display.value = this.currentModule;
                }
                
                // æ›´æ–° grid size é€‰é¡¹ï¼ˆç°åœ¨ä¼šè®¡ç®—æ‰€æœ‰å¯èƒ½çš„ moduleï¼‰
                this.updateGridSizeOptions();
            }

            // è®¡ç®— grid size é€‰é¡¹ - éå†æ‰€æœ‰å¯èƒ½çš„ module
            calculateGridSizeOptions() {
                const width = parseInt(document.getElementById('pageWidth').value);
                const height = parseInt(document.getElementById('pageHeight').value);

                if (!width || !height || width < 2 || height < 2) {
                    return [];
                }

                // å¦‚æœæ²¡æœ‰å¯ç”¨çš„ moduleï¼Œè¿”å›ç©ºæ•°ç»„
                if (!this.moduleOptions || this.moduleOptions.length === 0) {
                    return [];
                }

                // åˆå¹¶æ‰€æœ‰ module å¯¹åº”çš„ grid size
                const allGridSizes = new Set();

                // éå†æ‰€æœ‰å¯èƒ½çš„ module
                for (const m of this.moduleOptions) {
                    // è·å– x å’Œ y çš„è´¨å› æ•°åˆ†è§£
                    const xFactorization = this.getPrimeFactorization(width);
                    const yFactorization = this.getPrimeFactorization(height);

                    // ä» x å’Œ y çš„è´¨å› æ•°åˆ†è§£ä¸­é™¤å»ä¸€ä¸ª m
                    const xRemainder = this.removeFactorFromFactorization(xFactorization, m);
                    const yRemainder = this.removeFactorFromFactorization(yFactorization, m);

                    // åˆå¹¶ x å’Œ y çš„å‰©ä½™å› æ•°ï¼Œå¾—åˆ°æ‰€æœ‰å¯ç”¨çš„è´¨å› æ•°ï¼ˆå–æœ€å°powerï¼‰
                    const availableFactors = this.mergeFactorizations(xRemainder, yRemainder);

                    // é€’å½’ç”Ÿæˆæ‰€æœ‰ç»„åˆ
                    const generateCombinations = (factors, index, current) => {
                        const value = current * m;
                        if (value >= 5 && value <= 50) {
                            allGridSizes.add(value);
                        }
                        
                        if (index >= factors.length) {
                            return;
                        }
                        
                        const [prime, maxPower] = factors[index];
                        // ä¸é€‰è¿™ä¸ªè´¨å› æ•°
                        generateCombinations(factors, index + 1, current);
                        // é€‰æ‹©è¿™ä¸ªè´¨å› æ•°çš„ä¸åŒå¹‚æ¬¡
                        for (let power = 1; power <= maxPower; power++) {
                            generateCombinations(factors, index + 1, current * Math.pow(prime, power));
                        }
                    };
                    
                    generateCombinations(availableFactors, 0, 1);
                }

                // è½¬æ¢ä¸ºæ’åºæ•°ç»„
                return Array.from(allGridSizes).sort((a, b) => a - b);
            }

            // ä»è´¨å› æ•°åˆ†è§£ä¸­é™¤å»ä¸€ä¸ªå› å­
            removeFactorFromFactorization(factorization, factor) {
                const factorFactorization = this.getPrimeFactorization(factor);
                const result = JSON.parse(JSON.stringify(factorization)); // æ·±æ‹·è´

                for (const [prime, power] of factorFactorization) {
                    for (let i = 0; i < result.length; i++) {
                        if (result[i][0] === prime) {
                            result[i][1] -= power;
                            if (result[i][1] <= 0) {
                                result.splice(i, 1);
                            }
                            break;
                        }
                    }
                }

                return result;
            }

            // åˆå¹¶ä¸¤ä¸ªè´¨å› æ•°åˆ†è§£ï¼Œå–æœ€å° powerï¼ˆç¡®ä¿ grid size èƒ½åŒæ—¶æ•´é™¤ width å’Œ heightï¼‰
            mergeFactorizations(f1, f2) {
                const merged = new Map();

                // å…ˆæ”¶é›†æ‰€æœ‰çš„è´¨å› æ•°
                for (const [prime, power] of f1) {
                    merged.set(prime, power);
                }

                // å¯¹äºåœ¨ä¸¤è€…ä¸­éƒ½å­˜åœ¨çš„è´¨å› æ•°ï¼Œå–æœ€å° power
                // å¯¹äºåªåœ¨ä¸€ä¸ªä¸­å­˜åœ¨çš„è´¨å› æ•°ï¼Œä¸åŒ…å«ï¼ˆå› ä¸ºä¸èƒ½æ•´é™¤å¦ä¸€ä¸ªï¼‰
                const result = new Map();
                for (const [prime, power] of f2) {
                    if (merged.has(prime)) {
                        result.set(prime, Math.min(merged.get(prime), power));
                    }
                }

                return Array.from(result.entries());
            }

            // æ›´æ–° grid size é€‰é¡¹
            updateGridSizeOptions() {
                this.gridSizeOptions = this.calculateGridSizeOptions();
                
                console.log(`Available modules: ${this.moduleOptions.join(', ')}`);
                console.log(`Grid size options (combined from all modules): ${this.gridSizeOptions.join(', ')}`);
                
                this.updateGridSizeUI();
            }

            // æ›´æ–° grid size UI
            updateGridSizeUI() {
                const slider = document.getElementById('gridSizeSlider');
                const display = document.getElementById('gridSizeDisplay');
                const oldGridSize = this.currentGridSize;
                
                if (this.gridSizeOptions.length === 0) {
                    slider.disabled = true;
                    slider.min = 0;
                    slider.max = 0;
                    slider.value = 0;
                    display.value = '-';
                    this.currentGridSize = null;
                } else {
                    slider.disabled = false;
                    slider.min = 0;
                    slider.max = this.gridSizeOptions.length - 1;
                    slider.value = 0;
                    this.currentGridSize = this.gridSizeOptions[0];
                    display.value = this.currentGridSize;
                    this.updateCanvasGrid();
                }
                
                // å¦‚æœ grid size å˜åŒ–äº†ï¼Œè°ƒæ•´ç°æœ‰çš„ margin å€¼åˆ°æ–° grid size çš„å€æ•°
                if (oldGridSize !== this.currentGridSize && this.currentGridSize) {
                    this.adjustMarginsToGridSize();
                }
                
                // æ›´æ–° margin æŒ‰é’®çŠ¶æ€
                this.updateMarginButtonsState();
            }

            // å°†ç°æœ‰ margin è°ƒæ•´åˆ°æ–° grid size çš„å€æ•°
            adjustMarginsToGridSize() {
                const gridSize = this.currentGridSize;
                if (!gridSize) return;
                
                ['left', 'right', 'top', 'bottom'].forEach(side => {
                    const currentValue = this.margins[side];
                    if (currentValue > 0) {
                        // å‘ä¸‹å–æ•´åˆ°æœ€è¿‘çš„ grid size å€æ•°
                        const newValue = Math.floor(currentValue / gridSize) * gridSize;
                        this.margins[side] = newValue;
                        document.getElementById(`margin${side.charAt(0).toUpperCase() + side.slice(1)}`).value = newValue;
                    }
                });
                
                this.updateCanvasMargins();
                console.log(`Margins adjusted to grid size: ${gridSize} pt`);
            }

            // æ›´æ–° margin æŒ‰é’®çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
            updateMarginButtonsState() {
                const buttons = document.querySelectorAll('.stepper-btn');
                buttons.forEach(btn => {
                    btn.disabled = !this.currentGridSize;
                });
            }

            // æ›´æ–°ç”»å¸ƒä¸Šçš„ç½‘æ ¼
            updateCanvasGrid() {
                const grid = document.querySelector('.canvas-grid');
                if (!grid) {
                    return;
                }

                if (!this.currentGridSize) {
                    // å¦‚æœæ²¡æœ‰ grid sizeï¼Œéšè—ç½‘æ ¼
                    grid.style.opacity = '0';
                    return;
                }

                // æ˜¾ç¤ºç½‘æ ¼
                grid.style.opacity = '0.3';

                // ä½¿ç”¨ pt å•ä½ç›´æ¥è®¾ç½®ï¼Œè¿™æ ·ä¼šè·Ÿéšç”»å¸ƒä¸€èµ·ç¼©æ”¾
                grid.style.backgroundSize = `${this.currentGridSize}pt ${this.currentGridSize}pt`;
                
                console.log(`Grid updated: ${this.currentGridSize} pt`);
            }

            updateCanvasTransform(animate = false) {
                if (animate) {
                    this.canvasContainer.classList.add('animating');
                    this.canvasContainer.style.transform = 
                        `translate(calc(-50% + ${this.offsetX}px), calc(-50% + ${this.offsetY}px)) scale(${this.scale})`;
                    setTimeout(() => {
                        this.canvasContainer.classList.remove('animating');
                    }, 300);
                } else {
                    this.canvasContainer.style.transform = 
                        `translate(calc(-50% + ${this.offsetX}px), calc(-50% + ${this.offsetY}px)) scale(${this.scale})`;
                }
            }

            setupControlPanel() {
                // é¡µé¢å°ºå¯¸æ§åˆ¶
                const widthInput = document.getElementById('pageWidth');
                const heightInput = document.getElementById('pageHeight');
                
                // é™åˆ¶åªèƒ½è¾“å…¥æ•°å­—
                widthInput.addEventListener('keydown', (e) => {
                    this.restrictToNumbers(e, true);
                });
                
                heightInput.addEventListener('keydown', (e) => {
                    this.restrictToNumbers(e, true);
                });
                
                // é™åˆ¶ç²˜è´´å†…å®¹
                widthInput.addEventListener('paste', (e) => {
                    this.handleNumberPaste(e);
                });
                
                heightInput.addEventListener('paste', (e) => {
                    this.handleNumberPaste(e);
                });
                
                widthInput.addEventListener('input', () => {
                    this.updateCanvasSize();
                    
                    // é‡ç½® column/row è®¾ç½®ï¼ˆé¡µé¢å°ºå¯¸æ”¹å˜å½±å“æ‰€æœ‰è®¡ç®—ï¼‰
                    this.resetColumnRowSettings();
                    
                    this.updateModuleOptions();
                });

                heightInput.addEventListener('input', () => {
                    this.updateCanvasSize();
                    
                    // é‡ç½® column/row è®¾ç½®ï¼ˆé¡µé¢å°ºå¯¸æ”¹å˜å½±å“æ‰€æœ‰è®¡ç®—ï¼‰
                    this.resetColumnRowSettings();
                    
                    this.updateModuleOptions();
                });

                // Module æ»‘æ†æ§åˆ¶
                const moduleSlider = document.getElementById('moduleSlider');
                moduleSlider.addEventListener('input', (e) => {
                    const index = parseInt(e.target.value);
                    if (index >= 0 && index < this.moduleOptions.length) {
                        this.currentModule = this.moduleOptions[index];
                        document.getElementById('moduleDisplay').value = this.currentModule;
                        console.log(`Module set to: ${this.currentModule} pt`);
                        
                        // æ›´æ–° grid size é€‰é¡¹ï¼ˆä¸é‡ç½® column/rowï¼Œç­‰ grid size çœŸæ­£æ”¹å˜æ—¶å†å¤„ç†ï¼‰
                        this.updateGridSizeOptions();
                    }
                });

                // Grid Size æ»‘æ†æ§åˆ¶
                const gridSizeSlider = document.getElementById('gridSizeSlider');
                gridSizeSlider.addEventListener('input', (e) => {
                    const index = parseInt(e.target.value);
                    if (index >= 0 && index < this.gridSizeOptions.length) {
                        const oldGridSize = this.currentGridSize;
                        this.currentGridSize = this.gridSizeOptions[index];
                        document.getElementById('gridSizeDisplay').value = this.currentGridSize;
                        this.updateCanvasGrid();
                        
                        // è°ƒæ•´ç°æœ‰ margin åˆ°æ–°çš„ grid size å€æ•°
                        if (oldGridSize !== this.currentGridSize) {
                            this.adjustMarginsToGridSize();
                        }
                        
                        // è‡ªé€‚åº” column/row spacing
                        if (!oldGridSize) {
                            // å¦‚æœä¹‹å‰æ²¡æœ‰ grid sizeï¼Œåˆå§‹åŒ– spacing
                            this.initializeColumnRowSpacing();
                        } else {
                            // å¦‚æœä¹‹å‰æœ‰ grid sizeï¼Œè°ƒæ•´ spacing ä¸ºæ–° grid size çš„å€æ•°
                            this.adjustColumnRowSpacingToGridSize();
                        }
                        
                        console.log(`Grid size set to: ${this.currentGridSize} pt`);
                    }
                });

                // Column Spacing æ§åˆ¶æŒ‰é’®
                document.getElementById('columnSpacingDown').addEventListener('click', () => {
                    this.adjustColumnSpacing(-1);
                });
                
                document.getElementById('columnSpacingUp').addEventListener('click', () => {
                    this.adjustColumnSpacing(1);
                });

                // Row Spacing æ§åˆ¶æŒ‰é’®
                document.getElementById('rowSpacingDown').addEventListener('click', () => {
                    this.adjustRowSpacing(-1);
                });
                
                document.getElementById('rowSpacingUp').addEventListener('click', () => {
                    this.adjustRowSpacing(1);
                });

                // Column Number æ»‘æ†æ§åˆ¶
                const columnSlider = document.getElementById('columnSlider');
                columnSlider.addEventListener('input', (e) => {
                    const index = parseInt(e.target.value);
                    if (index >= 0 && index < this.columnOptions.length) {
                        this.currentColumnNumber = this.columnOptions[index];
                        document.getElementById('columnDisplay').value = this.currentColumnNumber;
                        this.drawColumns();
                        console.log(`Column number set to: ${this.currentColumnNumber}`);
                    }
                });

                // Row Number æ»‘æ†æ§åˆ¶
                const rowSlider = document.getElementById('rowSlider');
                rowSlider.addEventListener('input', (e) => {
                    const index = parseInt(e.target.value);
                    if (index >= 0 && index < this.rowOptions.length) {
                        this.currentRowNumber = this.rowOptions[index];
                        document.getElementById('rowDisplay').value = this.currentRowNumber;
                        this.drawRows();
                        console.log(`Row number set to: ${this.currentRowNumber}`);
                    }
                });

                // Margin æ§åˆ¶æŒ‰é’®
                document.querySelectorAll('.stepper-btn[data-margin]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const margin = e.currentTarget.getAttribute('data-margin');
                        const dir = parseInt(e.currentTarget.getAttribute('data-dir'));
                        this.adjustMargin(margin, dir);
                    });
                });

                // Margin é”å®šæŒ‰é’®
                document.getElementById('lockHorizontal').addEventListener('click', () => {
                    this.toggleMarginLock('horizontal');
                });

                document.getElementById('lockVertical').addEventListener('click', () => {
                    this.toggleMarginLock('vertical');
                });

                // åˆå§‹åŒ–é”å®šæŒ‰é’®çŠ¶æ€
                this.initMarginLockUI();
            }

            // åˆå§‹åŒ–é”å®šæŒ‰é’® UI
            initMarginLockUI() {
                ['horizontal', 'vertical'].forEach(type => {
                    const btn = document.getElementById(type === 'horizontal' ? 'lockHorizontal' : 'lockVertical');
                    const unlockedIcon = btn.querySelector('.icon-unlocked');
                    const lockedIcon = btn.querySelector('.icon-locked');
                    
                    if (this.marginLocks[type]) {
                        btn.classList.add('locked');
                        unlockedIcon.style.display = 'none';
                        lockedIcon.style.display = 'block';
                    } else {
                        btn.classList.remove('locked');
                        unlockedIcon.style.display = 'block';
                        lockedIcon.style.display = 'none';
                    }
                });
            }

            // åˆ‡æ¢ margin é”å®š
            toggleMarginLock(type) {
                this.marginLocks[type] = !this.marginLocks[type];
                const btn = document.getElementById(type === 'horizontal' ? 'lockHorizontal' : 'lockVertical');
                const unlockedIcon = btn.querySelector('.icon-unlocked');
                const lockedIcon = btn.querySelector('.icon-locked');
                
                if (this.marginLocks[type]) {
                    btn.classList.add('locked');
                    unlockedIcon.style.display = 'none';
                    lockedIcon.style.display = 'block';
                    
                    // é”å®šæ—¶ï¼Œå°†ä¸¤ä¸ªå€¼è®¾ä¸ºç›¸ç­‰ï¼ˆå–è¾ƒå¤§å€¼ï¼‰
                    if (type === 'horizontal') {
                        const maxValue = Math.max(this.margins.left, this.margins.right);
                        this.margins.left = maxValue;
                        this.margins.right = maxValue;
                        document.getElementById('marginLeft').value = maxValue;
                        document.getElementById('marginRight').value = maxValue;
                    } else {
                        const maxValue = Math.max(this.margins.top, this.margins.bottom);
                        this.margins.top = maxValue;
                        this.margins.bottom = maxValue;
                        document.getElementById('marginTop').value = maxValue;
                        document.getElementById('marginBottom').value = maxValue;
                    }
                    this.updateCanvasMargins();
                } else {
                    btn.classList.remove('locked');
                    unlockedIcon.style.display = 'block';
                    lockedIcon.style.display = 'none';
                }
            }

            // è°ƒæ•´ margin
            adjustMargin(side, direction) {
                const step = this.currentGridSize || 1;
                const newValue = Math.max(0, this.margins[side] + (direction * step));
                this.margins[side] = newValue;
                
                // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
                document.getElementById(`margin${side.charAt(0).toUpperCase() + side.slice(1)}`).value = newValue;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦è”åŠ¨è°ƒæ•´
                if ((side === 'left' || side === 'right') && this.marginLocks.horizontal) {
                    const otherSide = side === 'left' ? 'right' : 'left';
                    this.margins[otherSide] = newValue;
                    document.getElementById(`margin${otherSide.charAt(0).toUpperCase() + otherSide.slice(1)}`).value = newValue;
                }
                
                if ((side === 'top' || side === 'bottom') && this.marginLocks.vertical) {
                    const otherSide = side === 'top' ? 'bottom' : 'top';
                    this.margins[otherSide] = newValue;
                    document.getElementById(`margin${otherSide.charAt(0).toUpperCase() + otherSide.slice(1)}`).value = newValue;
                }
                
                // æ›´æ–°ç”»å¸ƒä¸Šçš„ margin æ˜¾ç¤º
                this.updateCanvasMargins();
                
                // æ›´æ–° column/row é€‰é¡¹ï¼ˆå› ä¸º margin å½±å“å¯ç”¨ç©ºé—´ï¼‰
                if (side === 'top' || side === 'bottom') {
                    this.updateColumnOptions();
                    // é‡æ–°ç»˜åˆ¶ column çº¿
                    if (this.currentColumnNumber) {
                        this.drawColumns();
                    }
                }
                if (side === 'left' || side === 'right') {
                    this.updateRowOptions();
                    // é‡æ–°ç»˜åˆ¶ row çº¿
                    if (this.currentRowNumber) {
                        this.drawRows();
                    }
                }
                
                console.log(`Margin ${side} set to: ${newValue} pt`);
            }

            // æ›´æ–°ç”»å¸ƒä¸Šçš„ margin æ˜¾ç¤º
            updateCanvasMargins() {
                // ä½¿ç”¨ pt å•ä½ï¼Œè¿™æ ·ä¼šéšç”»å¸ƒç¼©æ”¾
                const leftEl = document.getElementById('marginLeftVis');
                const rightEl = document.getElementById('marginRightVis');
                const topEl = document.getElementById('marginTopVis');
                const bottomEl = document.getElementById('marginBottomVis');

                // Left margin - çº¿åœ¨å·¦ä¾§
                if (this.margins.left > 0) {
                    leftEl.style.left = `${this.margins.left}pt`;
                    leftEl.style.opacity = '1';
                } else {
                    leftEl.style.opacity = '0';
                }

                // Right margin - çº¿åœ¨å³ä¾§
                if (this.margins.right > 0) {
                    rightEl.style.right = `${this.margins.right}pt`;
                    rightEl.style.opacity = '1';
                } else {
                    rightEl.style.opacity = '0';
                }

                // Top margin - çº¿åœ¨é¡¶éƒ¨
                if (this.margins.top > 0) {
                    topEl.style.top = `${this.margins.top}pt`;
                    topEl.style.opacity = '1';
                } else {
                    topEl.style.opacity = '0';
                }

                // Bottom margin - çº¿åœ¨åº•éƒ¨
                if (this.margins.bottom > 0) {
                    bottomEl.style.bottom = `${this.margins.bottom}pt`;
                    bottomEl.style.opacity = '1';
                } else {
                    bottomEl.style.opacity = '0';
                }
            }

            // Column/Row ç›¸å…³æ–¹æ³•

            // æ‰¾åˆ°æ•°ç»„ä¸­æœ€æ¥è¿‘ç›®æ ‡å€¼çš„å…ƒç´ çš„ç´¢å¼•
            findNearestIndex(array, target) {
                if (array.length === 0) return 0;
                
                let nearestIndex = 0;
                let minDiff = Math.abs(array[0] - target);
                
                for (let i = 1; i < array.length; i++) {
                    const diff = Math.abs(array[i] - target);
                    if (diff < minDiff) {
                        minDiff = diff;
                        nearestIndex = i;
                    }
                }
                
                return nearestIndex;
            }

            // é‡ç½® column/row è®¾ç½®
            resetColumnRowSettings() {
                // é‡ç½® spacing
                this.columnSpacing = null;
                this.rowSpacing = null;
                
                // é‡ç½®é€‰é¡¹å’Œå½“å‰å€¼
                this.columnOptions = [];
                this.rowOptions = [];
                this.currentColumnNumber = null;
                this.currentRowNumber = null;
                
                // æ¸…ç©ºç”»å¸ƒä¸Šçš„çº¿æ¡
                const columnContainer = document.getElementById('canvasColumns');
                const rowContainer = document.getElementById('canvasRows');
                if (columnContainer) columnContainer.innerHTML = '';
                if (rowContainer) rowContainer.innerHTML = '';
                
                // é‡ç½® UI æ˜¾ç¤º
                document.getElementById('columnSpacing').value = '-';
                document.getElementById('rowSpacing').value = '-';
                document.getElementById('columnDisplay').value = '-';
                document.getElementById('rowDisplay').value = '-';
                
                const columnSlider = document.getElementById('columnSlider');
                const rowSlider = document.getElementById('rowSlider');
                columnSlider.disabled = true;
                columnSlider.value = 0;
                rowSlider.disabled = true;
                rowSlider.value = 0;
                
                console.log('Column/Row settings reset');
            }

            // åˆå§‹åŒ– column spacing (é»˜è®¤ä¸º grid size)
            initializeColumnRowSpacing() {
                if (this.currentGridSize) {
                    // åªåœ¨è¿˜æ²¡æœ‰è®¾ç½®æ—¶æ‰åˆå§‹åŒ–
                    if (this.columnSpacing === null || this.columnSpacing === undefined) {
                        this.columnSpacing = this.currentGridSize;
                    }
                    if (this.rowSpacing === null || this.rowSpacing === undefined) {
                        this.rowSpacing = this.currentGridSize;
                    }
                    this.updateColumnRowUI();
                }
            }

            // å°† column/row spacing è°ƒæ•´ä¸ºæ–° grid size çš„å€æ•°
            adjustColumnRowSpacingToGridSize() {
                if (!this.currentGridSize) return;
                
                // è°ƒæ•´ column spacing
                if (this.columnSpacing !== null && this.columnSpacing !== undefined) {
                    // å‘ä¸‹å–æ•´åˆ°æœ€è¿‘çš„ grid size å€æ•°
                    const ratio = Math.floor(this.columnSpacing / this.currentGridSize);
                    this.columnSpacing = Math.max(0, ratio * this.currentGridSize);
                } else {
                    this.columnSpacing = this.currentGridSize;
                }
                
                // è°ƒæ•´ row spacing
                if (this.rowSpacing !== null && this.rowSpacing !== undefined) {
                    // å‘ä¸‹å–æ•´åˆ°æœ€è¿‘çš„ grid size å€æ•°
                    const ratio = Math.floor(this.rowSpacing / this.currentGridSize);
                    this.rowSpacing = Math.max(0, ratio * this.currentGridSize);
                } else {
                    this.rowSpacing = this.currentGridSize;
                }
                
                // æ›´æ–° UI å’Œé€‰é¡¹ï¼ˆè¿™ä¼šé‡æ–°è®¡ç®—å¯ç”¨çš„ column/row æ•°é‡å¹¶è‡ªåŠ¨é€‰æ‹©æœ€æ¥è¿‘çš„å€¼ï¼Œå¹¶é‡æ–°ç»˜åˆ¶çº¿æ¡ï¼‰
                this.updateColumnRowUI();
                
                console.log(`Column/Row spacing adjusted to grid size: column=${this.columnSpacing}pt, row=${this.rowSpacing}pt`);
            }

            // è°ƒæ•´ column spacing
            adjustColumnSpacing(direction) {
                if (!this.currentGridSize) return;
                
                const step = this.currentGridSize;
                const newValue = Math.max(0, this.columnSpacing + (direction * step));
                this.columnSpacing = newValue;
                
                document.getElementById('columnSpacing').value = newValue;
                
                // é‡æ–°è®¡ç®—å¯ç”¨çš„ column æ•°é‡
                this.updateColumnOptions();
                
                // é‡æ–°ç»˜åˆ¶ï¼ˆå¦‚æœå½“å‰æœ‰é€‰ä¸­çš„ column numberï¼‰
                if (this.currentColumnNumber) {
                    this.drawColumns();
                }
                
                console.log(`Column spacing set to: ${newValue} pt`);
            }

            // è°ƒæ•´ row spacing
            adjustRowSpacing(direction) {
                if (!this.currentGridSize) return;
                
                const step = this.currentGridSize;
                const newValue = Math.max(0, this.rowSpacing + (direction * step));
                this.rowSpacing = newValue;
                
                document.getElementById('rowSpacing').value = newValue;
                
                // é‡æ–°è®¡ç®—å¯ç”¨çš„ row æ•°é‡
                this.updateRowOptions();
                
                // é‡æ–°ç»˜åˆ¶ï¼ˆå¦‚æœå½“å‰æœ‰é€‰ä¸­çš„ row numberï¼‰
                if (this.currentRowNumber) {
                    this.drawRows();
                }
                
                console.log(`Row spacing set to: ${newValue} pt`);
            }

            // è®¡ç®—å¯ç”¨çš„ column æ•°é‡ï¼ˆColumn æ˜¯å‚ç›´åˆ’åˆ†ï¼ŒåŸºäº widthï¼‰
            calculateColumnOptions() {
                if (!this.currentGridSize || this.columnSpacing === null || this.columnSpacing === undefined) {
                    return [];
                }

                const x = parseInt(document.getElementById('pageWidth').value);  // width
                const l = this.margins.left;
                const r = this.margins.right;
                const cs = this.columnSpacing;
                const gridSize = this.currentGridSize;

                const options = [];
                
                // å¯¹äº c = 1 åˆ° 30ï¼Œæ£€æŸ¥ (x - l - r - (c-1) * cs) æ˜¯å¦èƒ½è¢« (grid_size * c) æ•´é™¤
                for (let c = 1; c <= 30; c++) {
                    const available = x - l - r - (c - 1) * cs;
                    // å¿…é¡»å¤§äº0ï¼Œä¸”èƒ½è¢« (grid_size * c) æ•´é™¤
                    if (available > 0 && available % (gridSize * c) === 0) {
                        options.push(c);
                    }
                }

                return options;
            }

            // è®¡ç®—å¯ç”¨çš„ row æ•°é‡ï¼ˆRow æ˜¯æ°´å¹³åˆ’åˆ†ï¼ŒåŸºäº heightï¼‰
            calculateRowOptions() {
                if (!this.currentGridSize || this.rowSpacing === null || this.rowSpacing === undefined) {
                    return [];
                }

                const y = parseInt(document.getElementById('pageHeight').value);  // height
                const t = this.margins.top;
                const b = this.margins.bottom;
                const rs = this.rowSpacing;
                const gridSize = this.currentGridSize;

                const options = [];
                
                // å¯¹äº rowNum = 1 åˆ° 30ï¼Œæ£€æŸ¥ (y - t - b - (rowNum-1) * rs) æ˜¯å¦èƒ½è¢« (grid_size * rowNum) æ•´é™¤
                for (let rowNum = 1; rowNum <= 30; rowNum++) {
                    const available = y - t - b - (rowNum - 1) * rs;
                    // å¿…é¡»å¤§äº0ï¼Œä¸”èƒ½è¢« (grid_size * rowNum) æ•´é™¤
                    if (available > 0 && available % (gridSize * rowNum) === 0) {
                        options.push(rowNum);
                    }
                }

                return options;
            }

            // æ›´æ–° column é€‰é¡¹
            updateColumnOptions() {
                this.columnOptions = this.calculateColumnOptions();
                
                console.log(`Column options: ${this.columnOptions.join(', ')}`);
                
                this.updateColumnUI();
            }

            // æ›´æ–° row é€‰é¡¹
            updateRowOptions() {
                this.rowOptions = this.calculateRowOptions();
                
                console.log(`Row options: ${this.rowOptions.join(', ')}`);
                
                this.updateRowUI();
            }

            // æ›´æ–° column UI
            updateColumnUI() {
                const slider = document.getElementById('columnSlider');
                const display = document.getElementById('columnDisplay');
                const previousColumnNumber = this.currentColumnNumber;
                
                if (this.columnOptions.length === 0) {
                    slider.disabled = true;
                    slider.min = 0;
                    slider.max = 0;
                    slider.value = 0;
                    display.value = '-';
                    this.currentColumnNumber = null;
                    this.drawColumns(); // æ¸…ç©ºçº¿æ¡
                } else {
                    slider.disabled = false;
                    slider.min = 0;
                    slider.max = this.columnOptions.length - 1;
                    
                    // å°è¯•ä¿ç•™æˆ–æ‰¾åˆ°æœ€æ¥è¿‘çš„é€‰é¡¹
                    let selectedIndex = 0;
                    if (previousColumnNumber !== null && previousColumnNumber !== undefined) {
                        // æ£€æŸ¥ä¹‹å‰çš„å€¼æ˜¯å¦è¿˜åœ¨é€‰é¡¹ä¸­
                        const exactIndex = this.columnOptions.indexOf(previousColumnNumber);
                        if (exactIndex !== -1) {
                            // ä¹‹å‰çš„å€¼è¿˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨
                            selectedIndex = exactIndex;
                        } else {
                            // æ‰¾åˆ°æœ€æ¥è¿‘çš„å€¼
                            selectedIndex = this.findNearestIndex(this.columnOptions, previousColumnNumber);
                        }
                    }
                    
                    slider.value = selectedIndex;
                    this.currentColumnNumber = this.columnOptions[selectedIndex];
                    display.value = this.currentColumnNumber;
                    this.drawColumns(); // ç»˜åˆ¶çº¿æ¡
                }
            }

            // æ›´æ–° row UI
            updateRowUI() {
                const slider = document.getElementById('rowSlider');
                const display = document.getElementById('rowDisplay');
                const previousRowNumber = this.currentRowNumber;
                
                if (this.rowOptions.length === 0) {
                    slider.disabled = true;
                    slider.min = 0;
                    slider.max = 0;
                    slider.value = 0;
                    display.value = '-';
                    this.currentRowNumber = null;
                    this.drawRows(); // æ¸…ç©ºçº¿æ¡
                } else {
                    slider.disabled = false;
                    slider.min = 0;
                    slider.max = this.rowOptions.length - 1;
                    
                    // å°è¯•ä¿ç•™æˆ–æ‰¾åˆ°æœ€æ¥è¿‘çš„é€‰é¡¹
                    let selectedIndex = 0;
                    if (previousRowNumber !== null && previousRowNumber !== undefined) {
                        // æ£€æŸ¥ä¹‹å‰çš„å€¼æ˜¯å¦è¿˜åœ¨é€‰é¡¹ä¸­
                        const exactIndex = this.rowOptions.indexOf(previousRowNumber);
                        if (exactIndex !== -1) {
                            // ä¹‹å‰çš„å€¼è¿˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨
                            selectedIndex = exactIndex;
                        } else {
                            // æ‰¾åˆ°æœ€æ¥è¿‘çš„å€¼
                            selectedIndex = this.findNearestIndex(this.rowOptions, previousRowNumber);
                        }
                    }
                    
                    slider.value = selectedIndex;
                    this.currentRowNumber = this.rowOptions[selectedIndex];
                    display.value = this.currentRowNumber;
                    this.drawRows(); // ç»˜åˆ¶çº¿æ¡
                }
            }

            // æ›´æ–° column/row UIï¼ˆspacing æ˜¾ç¤ºï¼‰
            updateColumnRowUI() {
                const columnSpacingInput = document.getElementById('columnSpacing');
                const rowSpacingInput = document.getElementById('rowSpacing');
                const columnSpacingDownBtn = document.getElementById('columnSpacingDown');
                const columnSpacingUpBtn = document.getElementById('columnSpacingUp');
                const rowSpacingDownBtn = document.getElementById('rowSpacingDown');
                const rowSpacingUpBtn = document.getElementById('rowSpacingUp');
                
                if (this.currentGridSize) {
                    // ä½¿ç”¨ !== null å’Œ !== undefined æ¥å…è®¸ spacing ä¸º 0
                    columnSpacingInput.value = (this.columnSpacing !== null && this.columnSpacing !== undefined) 
                        ? this.columnSpacing 
                        : this.currentGridSize;
                    rowSpacingInput.value = (this.rowSpacing !== null && this.rowSpacing !== undefined) 
                        ? this.rowSpacing 
                        : this.currentGridSize;
                    columnSpacingDownBtn.disabled = false;
                    columnSpacingUpBtn.disabled = false;
                    rowSpacingDownBtn.disabled = false;
                    rowSpacingUpBtn.disabled = false;
                    
                    // æ›´æ–° column å’Œ row é€‰é¡¹
                    this.updateColumnOptions();
                    this.updateRowOptions();
                } else {
                    columnSpacingInput.value = '-';
                    rowSpacingInput.value = '-';
                    columnSpacingDownBtn.disabled = true;
                    columnSpacingUpBtn.disabled = true;
                    rowSpacingDownBtn.disabled = true;
                    rowSpacingUpBtn.disabled = true;
                }
            }

            // ç»˜åˆ¶ Column çº¿ï¼ˆçºµå‘ï¼Œå‚ç›´çº¿ï¼‰- Column æ˜¯å‚ç›´åˆ’åˆ†ï¼ŒåŸºäº width
            drawColumns() {
                const container = document.getElementById('canvasColumns');
                container.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„çº¿
                
                if (!this.currentColumnNumber || this.currentColumnNumber < 1) {
                    return;
                }

                const x = parseInt(document.getElementById('pageWidth').value);
                const l = this.margins.left;
                const r = this.margins.right;
                const cs = this.columnSpacing;
                const c = this.currentColumnNumber;
                
                // è®¡ç®—æ€»çš„å¯ç”¨å®½åº¦ï¼ˆé™¤å»å·¦å³ marginï¼‰
                const availableWidth = x - l - r;
                
                // è®¡ç®—æ€»çš„ spacing å®½åº¦
                const totalSpacing = (c - 1) * cs;
                
                // è®¡ç®—æ¯ä¸ª column çš„å®½åº¦ï¼ˆå‰©ä½™ç©ºé—´å¹³å‡åˆ†é…ï¼‰
                const columnWidth = (availableWidth - totalSpacing) / c;
                
                let currentLeft = l;
                
                // ç»˜åˆ¶æ¯ä¸ª column å’Œ spacingï¼ˆè·³è¿‡ç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡çº¿ï¼Œé¿å…ä¸ margin é‡å ï¼‰
                for (let i = 0; i < c; i++) {
                    // è·³è¿‡ç¬¬ä¸€æ¡çº¿ï¼ˆi=0 æ—¶ï¼Œä¸ left margin é‡å ï¼‰
                    // ç»˜åˆ¶ column å·¦ä¾§çº¿
                    if (i > 0) {
                        const leftLine = document.createElement('div');
                        leftLine.className = 'column-line';
                        leftLine.style.left = `${currentLeft}pt`;
                        leftLine.style.top = '0';
                        leftLine.style.bottom = '0';
                        leftLine.style.width = '2px';
                        leftLine.style.height = 'auto';
                        leftLine.style.background = '#00ffff';
                        container.appendChild(leftLine);
                    }
                    
                    currentLeft += columnWidth;
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ª columnï¼Œç»˜åˆ¶ spacing çš„å·¦å³è¾¹ç•Œçº¿
                    if (i < c - 1) {
                        // Spacing å·¦ä¾§çº¿ï¼ˆä¹Ÿæ˜¯ column å³ä¾§çº¿ï¼‰
                        const spacingLeftLine = document.createElement('div');
                        spacingLeftLine.className = 'column-line';
                        spacingLeftLine.style.left = `${currentLeft}pt`;
                        spacingLeftLine.style.top = '0';
                        spacingLeftLine.style.bottom = '0';
                        spacingLeftLine.style.width = '2px';
                        spacingLeftLine.style.height = 'auto';
                        spacingLeftLine.style.background = '#00ffff';
                        container.appendChild(spacingLeftLine);
                        
                        currentLeft += cs;
                    }
                }
                
                // è·³è¿‡æœ€åä¸€æ¡çº¿ï¼ˆä¸ right margin é‡å ï¼‰
                // ä¸å†ç»˜åˆ¶ rightLine
            }

            // ç»˜åˆ¶ Row çº¿ï¼ˆæ¨ªå‘ï¼Œæ°´å¹³çº¿ï¼‰- Row æ˜¯æ°´å¹³åˆ’åˆ†ï¼ŒåŸºäº height
            drawRows() {
                const container = document.getElementById('canvasRows');
                container.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„çº¿
                
                if (!this.currentRowNumber || this.currentRowNumber < 1) {
                    return;
                }

                const y = parseInt(document.getElementById('pageHeight').value);
                const t = this.margins.top;
                const b = this.margins.bottom;
                const rs = this.rowSpacing;
                const rowNum = this.currentRowNumber;
                
                // è®¡ç®—æ€»çš„å¯ç”¨é«˜åº¦ï¼ˆé™¤å»ä¸Šä¸‹ marginï¼‰
                const availableHeight = y - t - b;
                
                // è®¡ç®—æ€»çš„ spacing é«˜åº¦
                const totalSpacing = (rowNum - 1) * rs;
                
                // è®¡ç®—æ¯ä¸ª row çš„é«˜åº¦ï¼ˆå‰©ä½™ç©ºé—´å¹³å‡åˆ†é…ï¼‰
                const rowHeight = (availableHeight - totalSpacing) / rowNum;
                
                let currentTop = t;
                
                // ç»˜åˆ¶æ¯ä¸ª row å’Œ spacingï¼ˆè·³è¿‡ç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡çº¿ï¼Œé¿å…ä¸ margin é‡å ï¼‰
                for (let i = 0; i < rowNum; i++) {
                    // è·³è¿‡ç¬¬ä¸€æ¡çº¿ï¼ˆi=0 æ—¶ï¼Œä¸ top margin é‡å ï¼‰
                    // ç»˜åˆ¶ row é¡¶éƒ¨çº¿
                    if (i > 0) {
                        const topLine = document.createElement('div');
                        topLine.className = 'row-line';
                        topLine.style.top = `${currentTop}pt`;
                        topLine.style.left = '0';
                        topLine.style.right = '0';
                        topLine.style.height = '2px';
                        topLine.style.width = 'auto';
                        topLine.style.background = '#00ffff';
                        container.appendChild(topLine);
                    }
                    
                    currentTop += rowHeight;
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ª rowï¼Œç»˜åˆ¶ spacing çš„ä¸Šä¸‹è¾¹ç•Œçº¿
                    if (i < rowNum - 1) {
                        // Spacing é¡¶éƒ¨çº¿ï¼ˆä¹Ÿæ˜¯ row åº•éƒ¨çº¿ï¼‰
                        const spacingTopLine = document.createElement('div');
                        spacingTopLine.className = 'row-line';
                        spacingTopLine.style.top = `${currentTop}pt`;
                        spacingTopLine.style.left = '0';
                        spacingTopLine.style.right = '0';
                        spacingTopLine.style.height = '2px';
                        spacingTopLine.style.width = 'auto';
                        spacingTopLine.style.background = '#00ffff';
                        container.appendChild(spacingTopLine);
                        
                        currentTop += rs;
                    }
                }
                
                // è·³è¿‡æœ€åä¸€æ¡çº¿ï¼ˆä¸ bottom margin é‡å ï¼‰
                // ä¸å†ç»˜åˆ¶ bottomLine
            }

            restrictToNumbers(e, allowDecimal = false) {
                // å…è®¸çš„æŒ‰é”®ï¼šæ•°å­—ã€é€€æ ¼ã€åˆ é™¤ã€æ–¹å‘é”®ã€Tabã€Enter
                const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab', 'Enter', 'Home', 'End'];
                
                // å…è®¸ Ctrl/Cmd + A, C, V, X (å…¨é€‰ã€å¤åˆ¶ã€ç²˜è´´ã€å‰ªåˆ‡)
                if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase())) {
                    return;
                }
                
                // å¦‚æœæ˜¯å…è®¸çš„æŒ‰é”®ï¼Œç›´æ¥é€šè¿‡
                if (allowedKeys.includes(e.key)) {
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°å­—
                if (e.key >= '0' && e.key <= '9') {
                    return;
                }
                
                // å¦‚æœå…è®¸å°æ•°ç‚¹ï¼Œæ£€æŸ¥å°æ•°ç‚¹
                if (allowDecimal && e.key === '.') {
                    // ç¡®ä¿åªæœ‰ä¸€ä¸ªå°æ•°ç‚¹
                    if (!e.target.value.includes('.')) {
                        return;
                    }
                }
                
                // é˜»æ­¢å…¶ä»–æ‰€æœ‰æŒ‰é”®
                e.preventDefault();
            }

            handleNumberPaste(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                // ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™æ•°å­—å’Œå°æ•°ç‚¹ï¼‰
                const cleanedText = pastedText.replace(/[^0-9.]/g, '');
                // ç¡®ä¿åªæœ‰ä¸€ä¸ªå°æ•°ç‚¹
                const parts = cleanedText.split('.');
                const finalText = parts.length > 1 ? parts[0] + '.' + parts.slice(1).join('') : cleanedText;
                
                if (finalText) {
                    // æ’å…¥æ¸…ç†åçš„æ–‡æœ¬
                    const input = e.target;
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    const currentValue = input.value;
                    input.value = currentValue.substring(0, start) + finalText + currentValue.substring(end);
                    // è®¾ç½®å…‰æ ‡ä½ç½®
                    const newPosition = start + finalText.length;
                    input.setSelectionRange(newPosition, newPosition);
                    // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°ç”»å¸ƒ
                    input.dispatchEvent(new Event('input'));
                }
            }

            updateCanvasSize() {
                const widthPt = parseFloat(document.getElementById('pageWidth').value);
                const heightPt = parseFloat(document.getElementById('pageHeight').value);
                
                if (widthPt && heightPt) {
                    // ä½¿ç”¨ptå•ä½è®¾ç½®CSSæ ·å¼
                    this.canvas.style.width = widthPt + 'pt';
                    this.canvas.style.height = heightPt + 'pt';
                    
                    // è‡ªåŠ¨é€‚é…ç¼©æ”¾ï¼ˆä¼ å…¥ptå€¼ï¼Œå‡½æ•°å†…éƒ¨ä¼šè½¬æ¢ï¼Œå¯ç”¨åŠ¨ç”»ï¼‰
                    this.fitCanvasToView(widthPt, heightPt, true);
                    
                    console.log(`ç”»å¸ƒå¤§å°å·²æ›´æ–°: ${widthPt}pt Ã— ${heightPt}pt`);
                }
            }

            fitCanvasToView(canvasWidthPt, canvasHeightPt, animate = false) {
                // å°†ptè½¬æ¢ä¸ºpxç”¨äºè®¡ç®—
                const canvasWidthPx = this.ptToPx(canvasWidthPt);
                const canvasHeightPx = this.ptToPx(canvasHeightPt);
                
                // è·å–ç”»å¸ƒæ˜¾ç¤ºåŒºåŸŸçš„å°ºå¯¸ï¼ˆpxï¼‰
                const canvasArea = this.canvasContainer.parentElement;
                const areaWidth = canvasArea.clientWidth;
                const areaHeight = canvasArea.clientHeight;
                
                // ç•™å‡ºè¾¹è· (margin, in px)
                const margin = 25;
                const availableWidth = areaWidth - margin * 2;
                const availableHeight = areaHeight - margin * 2;
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œè®©é•¿è¾¹é€‚é…åˆ°æ˜¾ç¤ºåŒºåŸŸ
                const scaleX = availableWidth / canvasWidthPx;
                const scaleY = availableHeight / canvasHeightPx;
                this.scale = Math.min(scaleX, scaleY);  // å–è¾ƒå°çš„æ¯”ä¾‹ç¡®ä¿ç”»å¸ƒå®Œå…¨å¯è§
                
                // é™åˆ¶æœ€å¤§ç¼©æ”¾æ¯”ä¾‹ï¼Œé¿å…è¿‡åº¦æ”¾å¤§
                this.scale = Math.min(this.scale, 3);
                // é™åˆ¶æœ€å°ç¼©æ”¾æ¯”ä¾‹
                this.scale = Math.max(this.scale, 0.05);
                
                // é‡ç½®åç§»ï¼Œè®©ç”»å¸ƒå±…ä¸­
                this.offsetX = 0;
                this.offsetY = 0;
                
                // æ›´æ–° transform å’Œ zoom display
                this.updateCanvasTransform(animate);
                this.updateZoomDisplay();
                
                console.log(`è‡ªåŠ¨é€‚é…: ç”»å¸ƒ ${canvasWidthPt}pt Ã— ${canvasHeightPt}pt, ç¼©æ”¾æ¯”ä¾‹ = ${(this.scale * 100).toFixed(1)}%`);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new GriDesigner();
        });
    </script>
</body>
</html>